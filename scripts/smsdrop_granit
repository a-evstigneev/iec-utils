#!/bin/sh

. /opt/iecd/utils
set_env DB_ACT DB_ARCH

smsparse()
{
	local _file _comaddr
	awk -v _file=$1 -v _comaddr=$2 '
		BEGIN {
			FS=","; FILE = _file; COMADDR = _comaddr; 
			TYPE["M_SP_TB_1"] = 30
			TYPE["M_ME_TF_1"] = 36
			cmd="/bin/date \047+%S%3N:%_M:%_k:%e:%u:%_m:%y\047 | /bin/sed \047s/^0*//g; s/ //g\047"
			
			OBJADDR["Zona1"] = 1; VALUE["Zona1"] = -1 
			OBJADDR["Zona2"] = 2; VALUE["Zona2"] = -1 
			OBJADDR["Zona3"] = 3; VALUE["Zona3"] = -1 
			OBJADDR["Zona4"] = 4; VALUE["Zona4"] = -1 
			OBJADDR["Akk"] 	 = 5; VALUE["Akk"]   = -1 
			OBJADDR["Set"]   = 6; VALUE["Set"]   = -1 
			OBJADDR["t="]    = 1; VALUE["t="]
		}
		
		{ 
			for (i = 1; i <= NF; ++i) {
				for (field in OBJADDR) { 
					if ($i ~ field) {
						if ($i ~ /norma/)
							VALUE[field] = 0
						else if ( ($i ~ /Neispravnost/) || ($i ~ /Pogar/) || ($i ~ /Trevoga/))
							VALUE[field] = 1
						else if ($i ~ /Net/)
							VALUE[field] = 1
						else if ($i ~ /t=/) 
							VALUE[field] = substr($i, index($i, "=") + 1)
						
					}
				}
			}
			
			cmd | getline timestamp; close(cmd)	

			for (field in OBJADDR) 
				if ( (field == "t=") && (VALUE[field] != ""))
					printf("%s %s %s %s %s %s\n", COMADDR, OBJADDR[field], TYPE["M_ME_TF_1"], VALUE[field], "-", timestamp) >> FILE
				else if (VALUE[field] != -1) 
					printf("%s %s %s %s %s %s\n", COMADDR, OBJADDR[field], TYPE["M_SP_TB_1"], VALUE[field], "-", timestamp) >> FILE
				
			close(FILE)
		}
	' 
}

comaddr="0"
if [ ! -z $1 ]; then
	comaddr=$1
fi

read sms
sms=$(/bin/echo -n -e `/bin/echo $sms | sed -r 's/.{2}/\\\\x&/g'` | /usr/bin/iconv -f UCS-2BE 2>/dev/null | tr -d "'")

if echo $sms | grep -q -e 'Vzayty na ohrany' -e 'Snayty s ohrany'; then
#	echo "Subject: iec104\r\n\r\nControlled station  = ${comaddr}, ${sms}" | msmtp --debug -a komisyk@gmail.com -t -i komisyk@mail.ru >/dev/null 2>&1
	exit 2
elif ! echo "$sms" | grep -q -E '.*Zona.:.*Akk.*Set.*t=.*gradus C'; then 
	exit 2 
fi

sms=$(echo $sms | sed 's/ gradus C//')

savedir="$DB_ARCH/$comaddr/$(/bin/date '+%Y-%m-%d')"
[ -d "$savedir" ] || mkdir -p "$savedir"

tempfile="$savedir/tempfile"
[ -f $tempfile ] && rm $tempfile 2>/dev/null 
touch $tempfile

if printf '%s\n' "$sms" | smsparse "$tempfile" "$comaddr"; then
	if sync $tempfile; then
   	# Create files that will store the signal values for a general interrogation
		while read _comaddr _objaddr _type _value _qds _timestamp; do
			case $_type in
				30)
					_type=1
				;;
				36)
					_type=13
				;;
			esac
			
			[ -d $DB_ACT/$_comaddr/$_type ] || mkdir -p $DB_ACT/$_comaddr/$_type
			echo $_value $_qds > $DB_ACT/$_comaddr/$_type/$_objaddr
			sync $DB_ACT/$_comaddr/$_type/$_objaddr
		done < $tempfile
	else
		exit 1
	fi
fi
