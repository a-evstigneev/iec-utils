#!/bin/sh

. $IECDIR/iecenv #DB_ARCH, DB_ACT, RTU, CTS, VARDIR, OID
. $IECDIR/io_utils #get_pctstamp
. $IECDIR/db_utils

usage() 
{
    echo "Usage: $0 [ -d dir ]"
    echo " "
    echo "  -d  oid file directory"
    echo " "
}

uncover()
{
    if echo "$1" | grep -q "-"; then 
        seq -s " " $(echo "$1" | tr - " ")
    else
        echo "$1"
    fi  
}

while getopts "d:" opt; do
    case $opt in
    d) oid=$OPTARG ;;
    *) usage; exit ;;
    esac
done

shift $(($OPTIND - 1))

[ -n "$oid" ] && OID=$oid

while read asduaddr ip model; do
    if [ "$model" = "mikrotik" ]; then
        mkdir -p $DB_ARCH/$asduaddr
		tmpfile="$DB_ARCH/$asduaddr/tmpsnmp"	
		
		while read objaddr type oidtable oidnum; do  
            j=0
			for i in $(uncover $oidnum); do
                value=$(snmpget -Oqn -v2c -c public "$ip" "${oidtable}.$i" | cut -d " " -f 2)
                echo $asduaddr $(($objaddr + $j)) $type $value - $(get_pctstamp)
                j=$(($j + 1))
            done >>$tmpfile
		done <"$OID/$model"

		if sync "$tmpfile"; then 	
			putdbact  "$tmpfile"
			putqueue  "$tmpfile" 
			putdbarch "$tmpfile"
		fi
		rm "$tmpfile"	
    fi  
done <"$RTU"
